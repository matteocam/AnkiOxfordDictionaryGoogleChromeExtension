<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
<body>
    <!-- JQuery version 1.7.1. -->
    <script src="js/jquery.min.js"></script>
    <script>
        chrome.contextMenus.create({
            "title": "Get definition and add to Anki",
            "type": "normal",
            "contexts": ["selection"],
            "onclick": process
        });

        chrome.contextMenus.create({
            "title": "Get definition and add to Anki with correction",
            "type": "normal",
            "contexts": ["selection"],
            "onclick": correctAndProcess
        });

        function translateAndAdd(askCorrection) {
            chrome.tabs.getSelected(null, function (tab) {
                chrome.tabs.sendRequest(tab.id, { action: "getSelectedText" }, function (response) {
                    var text = $.trim(response.selectedText);
                    if (askCorrection)
                        text = prompt(text, text);
                    chrome.tabs.sendRequest(tab.id, { "action": "showWindow", "word": text }, function (response) { });
                });
            });
        }

        chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
            if (request.action == "closeiframe") {
                chrome.tabs.getSelected(null, function (tab) {
                    chrome.tabs.sendRequest(tab.id, { action: "closeiframe" }, function (response) {
                        console.log('iframeclosed event triggered');
                    });
                });
            }
        });

        function process() {
            translateAndAdd(false)
        }

        function correctAndProcess() {
            translateAndAdd(true);
        }
    </script>
</body>
</html>
