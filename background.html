<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
<body>
    <!-- JQuery version 1.7.1. -->
    <script src="js/jquery.min.js"></script>
    <script>
        chrome.contextMenus.create({
            "title": (localStorage.addtoanki == true) ? "Get definition and add to Anki" : "Get word definition",
            "type": "normal",
            "contexts": ["selection"],
            "onclick": process
        });

        if (localStorage.allowcorrection == true) {
	        chrome.contextMenus.create({
	            "title": (localStorage.addtoanki == true) ? "Get definition and add to Anki with correction" : "Get word definition with correction",
	            "type": "normal",
	            "contexts": ["selection"],
	            "onclick": correctAndProcess
	        });
        }

        function translateAndAdd(askCorrection) {
            chrome.tabs.getSelected(null, function (tab) {
                chrome.tabs.sendRequest(tab.id, { action: "getSelectedText" }, function (response) {
                    var text = $.trim(response.selectedText);
                    if (askCorrection)
                        text = prompt(text, text);
                    chrome.tabs.sendRequest(tab.id, { "action": "showWindow", "word": text }, function (response) { });
                });
            });
        }

        chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
            if (request.action == "closeiframe") {
                chrome.tabs.getSelected(null, function (tab) {
                    chrome.tabs.sendRequest(tab.id, { action: "closeiframe" }, function (response) {
                        console.log('iframeclosed event triggered');
                    });
                });
            } else if (request.action == "getdataobject") {
            	var dataobject = {
                		'username': localStorage.username,
                		'password' : localStorage.password,
                		'deckname' : localStorage.deckname,
                		'addtoanki' : localStorage.addtoanki,
                		'allowcorrection' : localStorage.allowcorrection
                		};
            	sendResponse(dataobject);
            }
        });

        function process() {
            translateAndAdd(false)
        }

        function correctAndProcess() {
            translateAndAdd(true);
        }
    </script>
</body>
</html>
