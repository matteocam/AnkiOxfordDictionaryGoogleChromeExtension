<html>
<head>
    <meta charset="utf-8">
    <!-- JQuery version 1.7.1. -->
    <script src="js/jquery.min.js"></script>
    <link rel="stylesheet" href="css/window.css" type="text/css">
</head>
<body style="background-color: White">
    <script>
        var encodedPhrase = location.search.substring(6).toLowerCase();
        var decodedPhrase = decodeURI(encodedPhrase);
        getDefinition(decodedPhrase);

        function getDefinition(text) {
            var url = $.ajax({
                //url: "http://oxforddictionaries.com/definition/" + text + "?q=" + text,
                url: "http://oxforddictionaries.com/search/?region=uk&direct=1&q=" + encodeURI(text),
                success: function (data) {
                    var html = $(data);
                    var block = $("#entryPageContent", html);
                    var senseGroups = $(".senseGroup", block);
                    var correctedWord = $("span.pageTitle", html).text();
                    var json = '{"text" : "' + correctedWord + '", "parts" : [';
                    for (var i = 0; i < senseGroups.length; i++) {
                        var senseGroup = senseGroups.get(i);
                        var partOfSpeech = $("span.partOfSpeech", senseGroup).text();
                        var definitions = $("span.definition", senseGroup);

                        json += '{"part" : "' + partOfSpeech + '"';
                        json += ', "definitions" : [';
                        for (var j = 0; j < definitions.length; j++) {
                            var definition = definitions.get(j);
                            json += '"' + $(definition).text() + '"';
                            if (j < definitions.length - 1) {
                                json += ',';
                            }
                        }
                        json += ']}';
                        if (i < senseGroups.length - 1) {
                            json += ',';
                        }
                    }
                    json += ']}';
                    obj = JSON.parse(json);
                    showWindow(obj);
                },
                error: function (a, b, c) {
                    if ((a.readyState == 4) && (c == "Not Found")) {
                        alert("Definition for " + text + " couldn't be found");
                        //TODO add related searches
                        closeiframe();
                    }
                }
            });
        }

        function showWindow(obj) {
            var newLine = "\r\n";
            var definition = "";
            for (var i = 0; i < obj.parts.length; i++) {
                if ((obj.parts[i].part != null) && (obj.parts[i].part.length > 0)) {
                    definition += obj.parts[i].part + ':' + newLine;
                }
                for (var j = 0; j < obj.parts[i].definitions.length; j++) {
                    var item = obj.parts[i].definitions[j];
                    if (obj.parts[i].definitions.length > 1) {
                        definition += (j + 1) + '. ';
                    }
                    definition += $.trim(item.substring(0, item.length - 1)) + newLine;
                }
                definition += newLine;
            }

            $("#word").text($.trim(obj.text));
            $("#definition").val($.trim(definition));

            $("#go").click(function () {
                $.ajax({
                    type: 'POST',
                    url: 'http://ankiweb.net/account/login',
                    data: "submitted=1&username=" + localStorage.username + "&password=" + localStorage.password,
                    success: function (data) {
                        console.log('authorized');
                        $.ajax({
                            url: "http://ankiweb.net/deck/manage?cmd=setActive&deck=" + localStorage.deckname,
                            type: 'GET',
                            error: function (a, b, c) { alert('Authorization complete. Deck choose failed'); },
                            success: function (data) {
                                console.log('deck selected');
                                $.ajax({
                                    type: 'POST',
                                    url: 'http://ankiweb.net/deck/edit',
                                    error: function (a, b, c) { alert('Authorization complete. Adding card failed'); },
                                    data: $.param({ "Front": $("#word").text(), "Back": $("#definition").val(), "tags": "", "action": "Add" }),
                                    success: function (data) {
                                        console.log('card added');
                                        closeiframe();
                                    }
                                });
                            }
                        });
                    },
                    error: function (a, b, c) {
                        alert('Authorization failed. Check your username and password on options page');
                    }
                });
            });

            $("#close").click(closeiframe);
        }

        function closeiframe() {
            chrome.extension.sendRequest({ 'action': 'closeiframe' }, function (response) {});
        }
    </script>
    <span id="word"></span>
    <button id="close" value="close" name="close">Close</button>
    <button id="go" value="go" name="go">Add to Anki and close</button>
    <textarea id="definition" style="width: 470px; height: 260px"></textarea>
</body>
</html>